{% assign active_user_company = "gid://shopify/Company/" | append: customer.current_company.id %}
{% assign metaObject = shop.metaobjects.announcement_bar.values %}
{% assign now_timestamp = 'now' | date: '%s' | plus: 0 %}

<div 
  class="message-slider-section-wrapper page-width
  {% if section.settings.show_from_meta %}
    {% assign active_found = false %}
    {% for single_slide in metaObject %}
      {% assign raw_companies = single_slide.company | remove: '["' | remove: '"]' | replace: '","', ',' %}
      {% assign companies_array = raw_companies | split: ',' %}
      {% assign start_timestamp = single_slide.start_date | date: '%s' | plus: 0 %}
      {% assign end_timestamp = single_slide.end_date | date: '%s' | plus: 0 %}
      {% if companies_array contains active_user_company and now_timestamp >= start_timestamp and now_timestamp <= end_timestamp %}
        {% assign active_found = true %}
      {% endif %}
    {% endfor %}
    {% if active_found %}
     show-slider-meta
    {% else %}
     hide-slider-{{ section.id }}
    {% endif %}
  {% endif %}
  ">

<section class="message-slider" id="{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="message-slider__wrapper">
    {% if section.settings.show_from_meta %}
      <div class="message-slider__slides">
        {% for single_slide in metaObject %}
          {% assign raw_companies = single_slide.company | remove: '["' | remove: '"]' | replace: '","', ',' %}
          {% assign companies_array = raw_companies | split: ',' %}
          {% assign start_timestamp = single_slide.start_date | date: '%s' | plus: 0 %}
          {% assign end_timestamp = single_slide.end_date | date: '%s' | plus: 0 %}
          {% if companies_array contains active_user_company and now_timestamp >= start_timestamp and now_timestamp <= end_timestamp %}
            <div class="message-slide" {% if single_slide.banner_image != blank %} style="background-image: url('{{ single_slide.banner_image | img_url:"original" }}');background-size: 100% 100%;" {% endif %}>
              {% if single_slide.banner_video != blank %}
                {{ single_slide.banner_video.value | video_tag: autoplay: true, muted: true, loop: true, controls: false }}
              {% else %}
                {% if single_slide.name != blank %}
                  <h3 class="message-slide__title">{{ single_slide.name }}</h3>
                {% endif %}
                {% if single_slide.banner_content != blank %}
                  <div class="message-slide__content">{{ single_slide.banner_content | metafield_tag }}</div>
                {% endif %}
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}  
      <div class="message-slider__slides">
        {% for block in section.blocks %}
          <div class="message-slide">
            {% if block.settings.title != blank %}
              <h3 class="message-slide__title">{{ block.settings.title }}</h3>
            {% endif %}
            {% if block.settings.content != blank %}
              <div class="message-slide__content">{{ block.settings.content }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="message-slider__controls">
      <button class="slider-arrow prev" aria-label="Previous slide">&#10094;</button>
      <div class="slider-dots">
        {% if section.settings.show_from_meta %}
          {% for single_slide in metaObject %}
            {% assign raw_companies = single_slide.company | remove: '["' | remove: '"]' | replace: '","', ',' %}
            {% assign companies_array = raw_companies | split: ',' %}
            {% assign start_timestamp = single_slide.start_date | date: '%s' | plus: 0 %}
            {% assign end_timestamp = single_slide.end_date | date: '%s' | plus: 0 %}
            {% if companies_array contains active_user_company and now_timestamp >= start_timestamp and now_timestamp <= end_timestamp %}
              <span class="slider-dot{% if forloop.first %} active{% endif %}" data-index="{{ forloop.index0 }}"></span>
            {% endif %}
          {% endfor %}
        {% else %}  
          {% for block in section.blocks %}
            <span class="slider-dot{% if forloop.first %} active{% endif %}" data-index="{{ forloop.index0 }}"></span>
          {% endfor %}
        {% endif %}
      </div>
      <button class="slider-arrow next" aria-label="Next slide">&#10095;</button>
    </div>

    <button type="button" class="message-slider__hide">â€¦</button>
  </div>
</section>
</div>
