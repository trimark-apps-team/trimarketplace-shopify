
{% assign active_user_company = "gid://shopify/Company/" | append: customer.current_company.id %}
{% assign metaObject = shop.metaobjects.announcement_bar.values %}

{%- comment -%} Get current time in EDT as Unix timestamp {%- endcomment -%}
{% assign now_timestamp = 'now' | date: '%s' | plus: 0 %}

{% assign show_meta = false %}
{% for single_slide_data in metaObject %}
  {% assign raw_companies = single_slide_data.company | remove: '["' | remove: '"]' | replace: '","', ',' %}
  {% assign companies_array = raw_companies | split: ',' %}

  {% assign start_timestamp = single_slide_data.start_date | date: '%s' | plus: 0 %}
  {% assign end_timestamp = single_slide_data.end_date | date: '%s' | plus: 0 %}

  {% if companies_array contains active_user_company and now_timestamp >= start_timestamp and now_timestamp <= end_timestamp %}
    {% assign show_meta = true %}
  {% endif %}
{% endfor %}

<div 
  class="message-slider-section-wrapper page-width
  {% if section.settings.show_from_meta %}
    {% if show_meta %}
     show-slider-meta
    {% else %}
     hide-slider-{{ section.id }}
    {% endif %}
  {% endif %}
  ">
<section class="message-slider" id="{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="message-slider__wrapper">
    {% if section.settings.show_from_meta %}
      <div class="message-slider__slides">
        {% for single_slide in metaObject %}
          {% assign raw_companies = single_slide.company | remove: '["' | remove: '"]' | replace: '","', ',' %}
          {% assign companies_array = raw_companies | split: ',' %}
          {% if companies_array contains active_user_company %}
          <div class="message-slide" {% if single_slide.banner_image != blank %} style="background-image: url('{{ single_slide.banner_image | img_url:"original" }}');background-size: 100% 100%;" {% endif %}>
              {% if single_slide.banner_video != blank %}
                {{ single_slide.banner_video.value | video_tag: autoplay: true, muted: true, loop: true, controls: false }}
              {% else %}
                {% if single_slide.name != blank %}
                  <h3 class="message-slide__title">
                    {{ single_slide.name }}
                  </h3>
                {% endif %}
                {% if single_slide.banner_content != blank %}
                  <div class="message-slide__content">{{ single_slide.banner_content | metafield_tag }}</div>
                {% endif %}
              {% endif %}
              
            </div>
            {% endif %}
        {% endfor %}
      </div>
    {% else %}  
      <div class="message-slider__slides">
          {% for block in section.blocks %}
            <div class="message-slide">
              {% if block.settings.title != blank %}
                <h3 class="message-slide__title">
                  {{ block.settings.title }}
                </h3>
              {% endif %}
              {% if block.settings.content != blank %}
                <div class="message-slide__content">{{ block.settings.content }}</div>
              {% endif %}
            </div>
          {% endfor %}
      </div>
    {% endif %}
    <div class="message-slider__controls">
      <button class="slider-arrow prev" aria-label="Previous slide">&#10094;</button>
      <div class="slider-dots">
        {% if section.settings.show_from_meta %}
          {% for single_slide in metaObject %}
            {% assign raw_companies = single_slide.company | remove: '["' | remove: '"]' | replace: '","', ',' %}
            {% assign companies_array = raw_companies | split: ',' %}
            {% if companies_array contains active_user_company %}
              <span class="slider-dot{% if forloop.first %} active{% endif %}" data-index="{{ forloop.index0 }}"></span>
            {% endif %}
          {% endfor %}
        {% else %}  
          {% for block in section.blocks %}
            <span class="slider-dot{% if forloop.first %} active{% endif %}" data-index="{{ forloop.index0 }}"></span>
          {% endfor %}
        {% endif %}
      </div>
      <button class="slider-arrow next" aria-label="Next slide">&#10095;</button>
    </div>

    <button type="button" class="message-slider__hide">
      <?xml version="1.0"?><!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 1.1//EN'  'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'><svg enable-background="new 0 0 128 128" height="20px" id="Layer_1" version="1.1" viewBox="0 0 128 128" width="20px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g><path d="M84.815,43.399c-0.781-0.782-2.047-0.782-2.828,0L64.032,61.356L46.077,43.399c-0.781-0.782-2.047-0.782-2.828,0    c-0.781,0.781-0.781,2.047,0,2.828l17.955,17.957L43.249,82.141c-0.781,0.78-0.781,2.047,0,2.828    c0.391,0.39,0.902,0.585,1.414,0.585s1.023-0.195,1.414-0.585l17.955-17.956l17.955,17.956c0.391,0.39,0.902,0.585,1.414,0.585    s1.023-0.195,1.414-0.585c0.781-0.781,0.781-2.048,0-2.828L66.86,64.184l17.955-17.957C85.597,45.447,85.597,44.18,84.815,43.399z     M64.032,14.054c-27.642,0-50.129,22.487-50.129,50.127c0.002,27.643,22.491,50.131,50.133,50.131    c27.639,0,50.125-22.489,50.125-50.131C114.161,36.541,91.674,14.054,64.032,14.054z M64.036,110.313h-0.002    c-25.435,0-46.129-20.695-46.131-46.131c0-25.435,20.693-46.127,46.129-46.127s46.129,20.693,46.129,46.127    C110.161,89.617,89.47,110.313,64.036,110.313z"/></g></g></svg>
    </button>
  </div>
</section>
</div>
<style>
    .hide-slider-{{ section.id }} {
      display:none;
    }
    .message-slider {
      background: #fff;
      padding: 1rem;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
      max-width: 100%;
      margin: auto;
    }
    .message-slider__slides {
      display: flex;
      transition: transform 0.3s ease;
      will-change: transform;
    }
    .message-slide {
      flex: 0 0 100%;
      box-sizing: border-box;
    }
    .message-slide__title {
      font-weight: bold;
      margin: 0;
    }
    .message-slide__content {
      margin: 0.5rem 0;
    }
    .message-slider__controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 0.5rem;
    }
    .slider-dots {
      display: flex;
      gap: 6px;
    }
    .slider-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #ccc;
      border-radius: 50%;
      cursor: pointer;
    }
    .slider-dot.active {
      background: #b11830;
    }
    .slider-arrow {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #333;
      padding: 4px;
    }
    .slider-arrow:hover {
      color: #b11830;
    }
    .message-slider__hide {
      position: absolute;
      right: 10px;
      top: 10px;
      background: none;
      border: none;
      color: #333;
      cursor: pointer;
      font-size: 0.9rem;
    }
    #{{ section.id }} .message-slide .message-slide__title{
      color: {{ section.settings.header_color }};
      font-size: {{ section.settings.header_font_size }}px;
    }
    #{{ section.id }} .message-slide .message-slide__content{
      color: {{ section.settings.text_color }};
      font-size: {{ section.settings.text_font_size }}px;
      width: 99%;
    }
    #{{ section.id }} .message-slider__wrapper {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .message-slider-section-wrapper {
      margin-top: {{ section.settings.margin_top }}px;
      margin-bottom: {{ section.settings.margin_bottom }}px;
      width: 100%;
    }
    @media screen and (max-width: 749px) {
      #{{ section.id }} .message-slide .message-slide__title{
        color: {{ section.settings.header_color_mobile }};
        font-size: {{ section.settings.header_font_size_mobile }}px;
      }
      #{{ section.id }} .message-slide .message-slide__content{
        color: {{ section.settings.text_color_mobile }};
        font-size: {{ section.settings.text_font_size_mobile }}px;
      }
      #{{ section.id }} .message-slider__hide {
        display:none;
      }
      .message-slider-section-wrapper {
        margin-top: {{ section.settings.margin_top_mobile }}px;
        margin-bottom: {{ section.settings.margin_bottom_mobile }}px;
      }
    }

    @media screen and (max-width: 480px) {
      .message-slide {
        max-width: 100%;
        overflow-wrap: break-word;
        word-break: break-word;
      }

      #{{ section.id }} .message-slide .message-slide__content {
        max-width: 100%;
        width: auto;
      }

      .message-slider__slides {
        width: 100%;
      }

      .message-slider__controls {
        flex-wrap: wrap;
        gap: 6px;
      }
    }

  </style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.querySelector('[data-section-id="{{ section.id }}"]');
  const slidesWrapper = section.querySelector('.message-slider__slides');
  const hideBtn = section.querySelector('.message-slider__hide');
  const prevBtn = section.querySelector('.slider-arrow.prev');
  const nextBtn = section.querySelector('.slider-arrow.next');

  // --- Get all slides ---
  let slides = Array.from(slidesWrapper.querySelectorAll('.message-slide'));

  // --- Build dots ---
  let dotsWrapper = section.querySelector('.slider-dots');
  dotsWrapper.innerHTML = '';

  slides.forEach((_, i) => {
    const dot = document.createElement('span');
    dot.classList.add('slider-dot');
    if (i === 0) dot.classList.add('active');
    dot.dataset.index = i;
    dotsWrapper.appendChild(dot);
  });

  let dots = dotsWrapper.querySelectorAll('.slider-dot');
  let totalSlides = slides.length;
  let index = 0;
  let startX = 0;
  let currentX = 0;
  let isDragging = false;

  function updateSliderPosition() {
    slidesWrapper.style.transform = `translateX(-${index * 100}%)`;
    dots.forEach(d => d.classList.remove('active'));
    if (dots[index]) dots[index].classList.add('active');
  }

  // --- Dot navigation ---
  dots.forEach(dot => {
    dot.addEventListener('click', function() {
      index = parseInt(this.dataset.index);
      updateSliderPosition();
    });
  });

  // --- Prev/Next ---
  prevBtn.addEventListener('click', function() {
    index = index > 0 ? index - 1 : totalSlides - 1;
    updateSliderPosition();
  });

  nextBtn.addEventListener('click', function() {
    index = (index + 1) % totalSlides;
    updateSliderPosition();
  });

  // --- Hide button ---
  hideBtn.addEventListener('click', function() {
    section.style.display = 'none';
  });

  // --- Drag / Swipe ---
  slidesWrapper.addEventListener('mousedown', startDrag);
  slidesWrapper.addEventListener('touchstart', startDrag);

  slidesWrapper.addEventListener('mousemove', dragMove);
  slidesWrapper.addEventListener('touchmove', dragMove);

  slidesWrapper.addEventListener('mouseup', endDrag);
  slidesWrapper.addEventListener('mouseleave', endDrag);
  slidesWrapper.addEventListener('touchend', endDrag);

  function startDrag(e) {
    isDragging = true;
    startX = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
    slidesWrapper.style.transition = 'none';
  }

  function dragMove(e) {
    if (!isDragging) return;
    currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
    const deltaX = currentX - startX;
    slidesWrapper.style.transform = `translateX(${-index * 100 + (deltaX / section.offsetWidth) * 100}%)`;
  }

  function endDrag() {
    if (!isDragging) return;
    isDragging = false;
    const deltaX = (currentX || startX) - startX;
    if (deltaX > 50 && index > 0) {
      index--;
    } else if (deltaX < -50 && index < totalSlides - 1) {
      index++;
    }
    slidesWrapper.style.transition = 'transform 0.3s ease';
    updateSliderPosition();
    startX = 0;
    currentX = 0;
  }

  // --- Auto-slide ---
  if (totalSlides > 1) {
    setInterval(() => {
      index = (index + 1) % totalSlides;
      updateSliderPosition();
    }, 5000);
  }
});

</script>

{% schema %}
{
  "name": "Message Slider",
  "settings": [
        {
          "type": "checkbox",
          "id": "show_from_meta",
          "label": "Show From Meta",
          "default": false
        },
        { "type": "color", "id": "header_color", "label": "Header Color", "default": "#b11830" },
        { "type": "range", "id": "header_font_size", "label": "Header Font Size", "default": 18, "min": 12, "max": 100, "step": 1, "unit": "px" },
        { "type": "color", "id": "text_color", "label": "Text Color", "default": "#b11830" },
        { "type": "range", "id": "text_font_size", "label": "Text Font Size", "default": 18, "min": 12, "max": 100, "step": 1, "unit": "px" },
        { "type": "range", "id": "margin_top", "label": "Top Gap", "default": 18, "min": 0, "max": 100, "step": 1, "unit": "px" },
        { "type": "range", "id": "margin_bottom", "label": "Bottom Gap", "default": 18, "min": 0, "max": 100, "step": 1, "unit": "px" },
        { "type": "header", "content": "Mobile Settings" },
        { "type": "color", "id": "header_color_mobile", "label": "Header Color Mobile", "default": "#b11830" },
        { "type": "range", "id": "header_font_size_mobile", "label": "Header Font Size Mobile", "default": 18, "min": 12, "max": 100, "step": 1, "unit": "px" },
        { "type": "color", "id": "text_color_mobile", "label": "Text Color Mobile", "default": "#b11830" },
        { "type": "range", "id": "text_font_size_mobile", "label": "Text Font Size Mobile", "default": 18, "min": 12, "max": 100, "step": 1, "unit": "px" },
        { "type": "range", "id": "margin_top_mobile", "label": "Top Gap Mobile", "default": 18, "min": 0, "max": 100, "step": 1, "unit": "px" },
        { "type": "range", "id": "margin_bottom_mobile", "label": "Bottom Gap Mobile", "default": 18, "min": 0, "max": 100, "step": 1, "unit": "px" },
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "text", "id": "title", "label": "Title" },
        { "type": "richtext", "id": "content", "label": "Content" }
      ]
    }
  ],
  "max_blocks": 5,
  "presets": [
    {
      "name": "Message Slider",
      "category": "Custom"
    }
  ]
}
{% endschema %}