<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic@VERSION/dist/theme.min.css">



<script defer>
  document.addEventListener('DOMContentLoaded', function () {
    const { algoliasearch, autocomplete, getAlgoliaResults } = algoliaShopify.externals;

    const searchClient =
      algoliaShopify.searchClient ||
      algoliaShopify.externals.algoliasearch(
        algoliaShopify.config.app_id,
        algoliaShopify.config.search_api_key
      );

    const indexName = `${algoliaShopify.config.index_prefix}products`;

autocomplete({
  container: '#autocomplete-container',
  placeholder: 'Search products...',
  openOnFocus: false,

  getSources({ query }) {
    if (!query) return [];

        return [
          // üß† 1. Query suggestions
          {
            sourceId: 'querySuggestions',
            getItems() {
              return getAlgoliaResults({
                searchClient,
                queries: [
                  {
                    indexName: `${algoliaShopify.config.index_prefix}query_suggestions`,
                    params: {
                      query,
                      hitsPerPage: 5,
                    },
                  },
                ],
              });
            },
            templates: {
              header({ html }) {
                return html`<div class="aa-SourceHeader">
                  <span class="aa-SourceHeaderTitle">Suggestions</span>
                  <div class="aa-SourceHeaderLine"></div>
                </div>`;
              },
              item({ item, html }) {
                return html`
                  <div class="aa-ItemWrapper aa-SuggestionItem">
                    <div class="aa-ItemContent">
                      <div class="aa-ItemContentBody">
                        <div class="aa-ItemContentTitle">
                          ${html`${item.query}`}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              },
            },
          },

          // üõçÔ∏è 2. Product hits
          {
            sourceId: 'products',
            getItems() {
              return getAlgoliaResults({
                searchClient,
                queries: [
                  {
                    indexName: `${algoliaShopify.config.index_prefix}products`,
                    params: {
                      query,
                      hitsPerPage: 6,
                    },
                  },
                ],
              });
            },
            templates: {
              header({ html }) {
                return html`<div class="aa-SourceHeader">
                  <span class="aa-SourceHeaderTitle">Products</span>
                  <div class="aa-SourceHeaderLine"></div>
                </div>`;
              },
              item({ item, components, html }) {
                const productUrl = item.url || `/products/${item.handle}`;
                const price = item.price;
                const uom =
                  item.metafields?.custom?.uom ||
                  item.metafields?.custom?.['1_uom_ab_sx'] ||
                  item.metafields?.custom?.['1_uom_rwsmith_sx'] ||
                  '';

                return html`
                  <div class="aa-ItemWrapper">
                    <a href="${productUrl}" class="aa-ItemLink">
                      <div class="aa-ItemContent">
                        <div class="aa-ItemPicture">
                          <img src="${item.image || item.image_url}" alt="${item.title}" />
                        </div>
                        <div class="aa-ItemContentBody">
                          <div class="aa-ItemContentTitle">
                            ${components.Highlight({ hit: item, attribute: 'title' })}
                          </div>
                          <div class="aa-ItemContentVendor">
                            ${components.Highlight({ hit: item, attribute: 'vendor' })}
                          </div>
                          <div class="aa-ItemContentPrice">
                            ${price ? html`$${price}` : ''}
                            ${uom ? html`<span class="aa-ItemUOM"> / ${uom}</span>` : ''}
                          </div>
                        </div>
                      </div>
                    </a>
                  </div>
                `;
              },
              noResults() {
                return 'No results found';
              },
            },
          },
        ];
      },
    });
  });
</script>
