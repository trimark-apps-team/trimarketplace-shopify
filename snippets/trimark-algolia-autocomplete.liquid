<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic@VERSION/dist/theme.min.css">
<link
  rel="stylesheet"
  href="{{ 'trimark-algolia-autocomplete-overrides.css' | asset_url }}"
>
<script defer>
document.addEventListener('DOMContentLoaded', function () {
  const { algoliasearch, autocomplete, getAlgoliaResults } = algoliaShopify.externals;

  const searchClient =
    algoliaShopify.searchClient ||
    algoliasearch(
      algoliaShopify.config.app_id,
      algoliaShopify.config.search_api_key
    );

  const productsIndex = `${algoliaShopify.config.index_prefix}products`;
  const suggestionsIndex = `${algoliaShopify.config.index_prefix}products_query_suggestions`;

  const autoInstance = autocomplete({
    container: '#autocomplete-container',
    placeholder: 'Search Products...',
    openOnFocus: true,
    onSubmit({ state }) {
      const query = state.query;
      if (query) {
        window.location.href = `/search?q=${encodeURIComponent(query)}`;
      }
    },
    getSources({ query }) {
      if (query.length < 1) return [];

      return [
        {
          sourceId: 'querySuggestions',
          getItems() {
            return getAlgoliaResults({
              searchClient,
              queries: [
                {
                  indexName: suggestionsIndex,
                  params: {
                    query,
                    hitsPerPage: 5,
                  },
                },
              ],
            });
          },
          onSelect({ item }) {
            window.location.href = `/search?q=${encodeURIComponent(item.query)}`;
          },
          templates: {
            header({ html }) {
              return html`
                <div class="aa-SourceHeader">
                  <div class="aa-SourceHeaderTitle">Suggestions</div>
                  <div class="aa-SourceHeaderLine"></div>
                </div>
              `;
            },
            item({ item, html }) {
              return html`
                <div class="aa-ItemWrapper aa-SuggestionItem">
                  <div class="aa-ItemContent">
                    <div class="aa-ItemContentBody">
                      <div class="aa-ItemContentTitle">${html`${item.query}`}</div>
                    </div>
                  </div>
                </div>
              `;
            },
          },
        },
        {
          sourceId: 'products',
          getItems() {
            return getAlgoliaResults({
              searchClient,
              queries: [
                {
                  indexName: productsIndex,
                  params: {
                    query,
                    hitsPerPage: 10,
                  },
                },
              ],
            });
          },
          templates: {
            header({ html }) {
              return html`
                <div class="aa-SourceHeader">
                  <div class="aa-SourceHeaderTitle">Products</div>
                  <div class="aa-SourceHeaderLine"></div>
                </div>
              `;
            },
            item({ item, components, html }) {
              const productUrl = item.url || `/products/${item.handle}`;
              const price = item?.price;
              const uom = item?.meta?.custom?.['3_uom'] ?? '';

              return html`
                <div class="aa-ItemWrapper">
                  <a href="${productUrl}" class="aa-ItemLink">
                    <div class="aa-ItemContent">
                      <div class="aa-ItemPicture aa-ItemPicture--loaded">
                        <img src="${item.image || item.image_url}" alt="${item.title}" />
                      </div>
                      <div class="aa-ItemContentBody">
                      <div class="aa-ItemContentVendor">
                          ${components.Highlight({ hit: item, attribute: 'vendor' })}
                        </div>
                        <div class="aa-ItemContentTitle">
                          ${components.Highlight({ hit: item, attribute: 'title' })}
                        </div>
                        <!-- 
                        <div class="aa-ItemContentPrice">
                          ${price ? html`$${price}` : ''}
                          ${uom ? html`<span class="aa-ItemUOM">${uom}</span>` : ''}
                        </div> 
                        -->
                      </div>
                    </div>
                  </a>
                </div>
              `;
            },
          },
        },
      ];
    },
    render({ sections, html, render }, root) {
      render(
        html`
          <div class="aa-PanelLayout">
            <div class="aa-PanelColumn aa-PanelColumn-suggestions">${sections[0]}</div>
            <div class="aa-PanelColumn aa-PanelColumn-products">${sections[1]}</div>
          </div>
        `,
        root
      );
    },
  });
});
</script>
