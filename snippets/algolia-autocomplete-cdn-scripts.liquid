<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic@VERSION/dist/theme.min.css">



<script defer>
  document.addEventListener('DOMContentLoaded', function () {
    const { algoliasearch, autocomplete, getAlgoliaResults } = algoliaShopify.externals;

    const searchClient =
      algoliaShopify.searchClient ||
      algoliaShopify.externals.algoliasearch(
        algoliaShopify.config.app_id,
        algoliaShopify.config.search_api_key
      );

    const indexName = `${algoliaShopify.config.index_prefix}products`;

    autocomplete({
      container: '#autocomplete-container',
      placeholder: 'Search products...',
      openOnFocus: true,

      getSources({ query }) {
        return [
          {
            sourceId: 'products',
            getItems() {
              return getAlgoliaResults({
                searchClient,
                queries: [
                  {
                    indexName,
                    params: { query, hitsPerPage: 5 },
                  },
                ],
              });
            },

            templates: {
              // ðŸ§© Each result card
              item({ item, components, html }) {
                const productUrl = item.url || `/products/${item.handle}`;
                const variantId = item.objectID?.split('_').pop(); // handle variant fallback

                return html`
                  <div class="aa-ItemWrapper">
                    <a href="${productUrl}" class="aa-ItemLink">
                      <div class="aa-ItemContent">
                        <div class="aa-ItemIcon">
                          <img
                            src="${item.image || item.image_url}"
                            alt="${item.name}"
                            width="50"
                            height="50"
                          />
                        </div>
                        <div class="aa-ItemContentBody">
                          <div class="aa-ItemContentTitle">
                            ${components.Highlight({
                              hit: item,
                              attribute: 'name',
                            })}
                          </div>
                          <div class="aa-ItemContentPrice">
                            ${Shopify.formatMoney(item.price, window.shopMoneyFormat || '${{amount}}')}
                          </div>
                        </div>
                      </div>
                    </a>

                    <button
                      class="aa-AddToCart"
                      data-variant-id="${variantId}"
                      type="button"
                    >
                      Add to cart
                    </button>
                  </div>
                `;
              },

              noResults() {
                return 'No results found';
              },
            },
          },
        ];
      },
    });

    // ðŸ›’ Handle add-to-cart clicks
    document.body.addEventListener('click', async (e) => {
      const btn = e.target.closest('.aa-AddToCart');
      if (!btn) return;

      const id = btn.dataset.variantId;
      if (!id) return console.warn('Missing variant ID');

      try {
        btn.disabled = true;
        await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, quantity: 1 }),
        });
        btn.textContent = 'Added!';
        setTimeout(() => (btn.textContent = 'Add to cart', btn.disabled = false), 2000);
      } catch (err) {
        console.error('Add to cart failed', err);
        btn.disabled = false;
      }
    });
  });
</script>
