

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@8.5.1/themes/reset-min.css" integrity="sha256-KvFgFCzgqSErAPu6y9gz/AhZAvzK48VJASu3DpNLCEQ=" crossorigin="anonymous">
<link
  rel="stylesheet"
  href="{{ 'trimark-algolia-instantsearch-overrides.css' | asset_url }}"
>
<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const { algoliasearch, instantsearch, widgets, connectors } = algoliaShopify.externals;
  // Destructure widgets from the top-level `widgets` object (not instantsearch.widgets)
  const {
    searchBox,
    hits,
    pagination,
    refinementList,
    clearRefinements,
    configure,
    rangeInput,
    panel
  } = widgets;

   const { connectCurrentRefinements } = connectors;
  

  const searchClient =
    algoliaShopify.searchClient ||
    algoliasearch(
      algoliaShopify.config.app_id,
      algoliaShopify.config.search_api_key
    );

  const indexName = `${algoliaShopify.config.index_prefix}products`;

  // Build a connected widget
const customCurrentRefinements = instantsearch.connectors.connectCurrentRefinements(
  (renderOptions, isFirstRender) => {
    const { items, refine, widgetParams } = renderOptions;

    if (isFirstRender) {
      widgetParams.container.innerHTML = `
        <div class="ais-CustomCurrentRefinements">
          <h4>Selected Filters</h4>
          <div class="ais-CustomCurrentRefinements-list"></div>
          <button class="ais-CustomCurrentRefinements-clear">Clear all</button>
        </div>`;
      widgetParams.container
        .querySelector('.ais-CustomCurrentRefinements-clear')
        .addEventListener('click', () => refine([]));
    }

    const list = widgetParams.container.querySelector(
      '.ais-CustomCurrentRefinements-list'
    );

    list.innerHTML = items
      .map(
        (item) => `
        <div class="ais-CustomCurrentRefinements-item">
          <span class="ais-CustomCurrentRefinements-label">${item.label}: ${item.refinements
            .map((ref) => ref.label)
            .join(', ')}</span>
          <button data-attribute="${item.attribute}">✕</button>
        </div>`
      )
      .join('');

    list.querySelectorAll('button').forEach((btn) =>
      btn.addEventListener('click', () => {
        const attribute = btn.getAttribute('data-attribute');
        const refinement = items.find((i) => i.attribute === attribute);
        if (refinement) refine(refinement.refinements);
      })
    );
  }
);

  const search = instantsearch({
    indexName,
    searchClient,
    routing: {
    stateMapping: {
      stateToRoute(uiState) {
        return {
          query: uiState[indexName]?.query || '',
          page: uiState[indexName]?.page || 1,
        };
      },
      routeToState(routeState) {
        return {
          [indexName]: {
            query: routeState.query || '',
            page: routeState.page || 1,
          },
        };
      },
    },
  },
});

  search.addWidgets([
    searchBox({
      container: '#searchbox',
      placeholder: 'Search products...',
    }),

    clearRefinements({
      container: '#clear-refinements',
    }),
  customCurrentRefinements({
    container: document.querySelector('#current-refinements'),
  }),

  widgets.panel({
  templates: { header: 'Brand' },
})(widgets.refinementList)({
  container: '#brand-list',
  attribute: 'vendor',
  limit: 10,            // show 20 types initially
  showMore: true,       // enable "Show more" button
  showMoreLimit: 100,   // max total when expanded
}),

widgets.panel({
  templates: { header: 'Product Type' },
})(widgets.refinementList)({
  container: '#product-type',
  attribute: 'product_type',
  limit: 10,            // show 20 types initially
  showMore: true,       // enable "Show more" button
  showMoreLimit: 100,   // max total when expanded
}),

  widgets.panel({
    templates: { header: 'Tags' },
  })(widgets.refinementList)({
    container: '#tags',
    attribute: 'tags',
  }),

  widgets.panel({
    templates: { header: 'Price Range' },
  })(widgets.refinementList)({
    container: '#price-range',
    attribute: 'price_range',
    sortBy: (a, b) => {
      const getStart = (label) => parseFloat(label.split(':')[0]) || 0;
      return getStart(a.name) - getStart(b.name);
    },
    limit: 10,
    showMore: true,
    showMoreLimit: 30,
    templates: {
      item(item, { html }) {
        const label = item.label.includes(':')
          ? item.label
              .split(':')
              .map((v, i) =>
                i === 0 ? `$${v.trim()}` : v ? `$${v.trim()}` : '+'
              )
              .join(' – ')
          : `$${item.label}`;
        return html`
          <label class="ais-RefinementList-label">
            <input
              type="checkbox"
              class="ais-RefinementList-checkbox"
              ${item.isRefined ? 'checked' : ''}
            />
            <span class="ais-RefinementList-labelText">${label}</span>
            <span class="ais-RefinementList-count">${item.count}</span>
          </label>
        `;
      },
    },
  }),
 widgets.sortBy({
  container: '#sort-by',
  items: [
    { label: 'Relevance', value: `${indexName}` },
    { label: 'Price (asc)', value: `${indexName}_price_asc` },
    { label: 'Price (desc)', value: `${indexName}_price_desc` },
  ],
}),


hits({
  container: '#hits',
  templates: {
    item(hit, { html, components }) {
      const productUrl = hit.url || `/products/${hit.handle}`;
      const price = hit.price;
      const uom = hit.meta?.custom?.['3_uom'] || '';

      return html`
        <div class="ais-HitWrapper">
          <a href="${productUrl}" class="ais-HitLink">
            <div class="ais-HitContent">
              <div class="ais-HitPicture">
                <img
                  src="${hit.image || hit.image_url}"
                  alt="${hit.title}"
                  loading="lazy"
                />
              </div>
              <div class="ais-HitContentBody">
                <div class="ais-HitVendor">
                  ${components.Highlight({ hit, attribute: 'vendor' })}
                </div>
                <div class="ais-HitTitle">
                  ${components.Highlight({ hit, attribute: 'title' })}
                </div>
             
                <div class="ais-HitPrice">
                          ${price ? html`$${price}` : ''}
                          ${uom ? html`<span class="aa-ItemUOM"> ${uom}</span>` : ''}
                        </div>
              </div>
            </div>
          </a>
        </div>
      `;
    },
  },
}),

    pagination({
      container: '#pagination',
    }),

    configure({
      hitsPerPage: 30,
    }),
  ]);

  search.start();


    document.addEventListener('click', (e) => {
        const header = e.target.closest('.ais-Panel-header');
        if (!header) return;

        const panel = header.closest('.ais-Panel');
        if (!panel) return;

        panel.classList.toggle('ais-Panel--collapsed');
    });
});
</script>