

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@8.5.1/themes/reset-min.css" integrity="sha256-KvFgFCzgqSErAPu6y9gz/AhZAvzK48VJASu3DpNLCEQ=" crossorigin="anonymous">
<link
  rel="stylesheet"
  href="{{ 'trimark-algolia-instantsearch-overrides.css' | asset_url }}"
>
<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const { algoliasearch, instantsearch, widgets, connectors } = algoliaShopify.externals;
  // Destructure widgets from the top-level `widgets` object (not instantsearch.widgets)
  const {
    searchBox,
    hits,
    pagination,
    refinementList,
    clearRefinements,
    configure,
    rangeInput,
    panel
  } = widgets;

   const { connectCurrentRefinements } = connectors;
  

  const searchClient =
    algoliaShopify.searchClient ||
    algoliasearch(
      algoliaShopify.config.app_id,
      algoliaShopify.config.search_api_key
    );

  const indexName = `${algoliaShopify.config.index_prefix}products`;

  const customCurrentRefinements = connectCurrentRefinements((renderOptions, isFirstRender) => {
    const { items, refine } = renderOptions;

    const container = document.querySelector('#selected-filters');
    if (isFirstRender) {
      container.innerHTML = `
        <div class="ais-CurrentRefinements">
          <ul class="ais-CurrentRefinements-list"></ul>
        </div>
      `;
    }

    const list = container.querySelector('.ais-CurrentRefinements-list');
    list.innerHTML = items
      .map(
        (group) => `
        <li class="ais-CurrentRefinements-item">
          <strong>${group.attribute.replace(/_/g, ' ')}</strong>:
          ${group.refinements
            .map(
              (refinement) => `
              <span class="ais-CurrentRefinements-label">
                ${refinement.label.replace(':', '–')}
                <button class="ais-CurrentRefinements-remove" data-attribute="${group.attribute}" data-label="${refinement.label}">×</button>
              </span>
            `
            )
            .join('')}
        </li>`
      )
      .join('');

    list.querySelectorAll('.ais-CurrentRefinements-remove').forEach((btn) => {
      const attr = btn.dataset.attribute;
      const label = btn.dataset.label;
      const group = items.find((g) => g.attribute === attr);
      const refinement = group?.refinements.find((r) => r.label === label);
      if (refinement) {
        btn.onclick = () => refine(refinement);
      }
    });
  });

  const search = instantsearch({
    indexName,
    searchClient,
    routing: {
    stateMapping: {
      stateToRoute(uiState) {
        return {
          query: uiState[indexName]?.query || '',
          page: uiState[indexName]?.page || 1,
        };
      },
      routeToState(routeState) {
        return {
          [indexName]: {
            query: routeState.query || '',
            page: routeState.page || 1,
          },
        };
      },
    },
  },
});

  search.addWidgets([
    searchBox({
      container: '#searchbox',
      placeholder: 'Search Products...',
  }),
    clearRefinements({
    container: '#clear-refinements',
    templates: {
      resetLabel: 'Clear all',
    },
    cssClasses: {
      button: 'ais-CurrentRefinements-clearAll',
    },
  }),

  customCurrentRefinements({
    container: document.querySelector('#current-refinements'),
  }),

  widgets.panel({
  templates: { header: 'Vendor' },
})(widgets.refinementList)({
  container: '#brand-list',
  attribute: 'vendor',
  limit: 10,            // show 20 types initially
  showMore: true,       // enable "Show more" button
  showMoreLimit: 100,   // max total when expanded
}),

widgets.panel({
  templates: { header: 'Product Type' },
})(widgets.refinementList)({
  container: '#product-type',
  attribute: 'product_type',
  limit: 10,            // show 20 types initially
  showMore: true,       // enable "Show more" button
  showMoreLimit: 100,   // max total when expanded
}),

  widgets.panel({
    templates: { header: 'Tags' },
  })(widgets.refinementList)({
    container: '#tags',
    attribute: 'tags',
  }),

widgets.panel({
  templates: { header: 'Price Range' },
})(widgets.refinementList)({
  container: '#price-range',
  attribute: 'price_range',
  sortBy: (a, b) => {
    const getStart = (label) => parseFloat(label.split(':')[0]) || 0;
    return getStart(a.name) - getStart(b.name);
  },
  limit: 10,
  showMore: true,
  showMoreLimit: 30,
  transformItems(items) {
    return items.map(item => {
      const formattedLabel = item.label.includes(':')
        ? item.label
            .split(':')
            .map((v, i) =>
              i === 0 ? `$${v.trim()}` : v ? `$${v.trim()}` : '+'
            )
            .join(' – ')
        : `$${item.label}`;
      return {
        ...item,
        label: formattedLabel,
        name: formattedLabel, // also update `name` so refinement pills show dashes, not colons
      };
    });
  },
}),

 widgets.sortBy({
  container: '#sort-by',
  items: [
    { label: 'Relevance', value: `${indexName}` },
    { label: 'Price (asc)', value: `${indexName}_price_asc` },
    { label: 'Price (desc)', value: `${indexName}_price_desc` },
  ],
}),


hits({
  container: '#hits',
  templates: {
    item(hit, { html, components }) {
      const productUrl = hit.url || `/products/${hit.handle}`;
      const price = hit.price;
      const uom = hit.meta?.custom?.['3_uom'] || '';

      return html`
        <div class="ais-HitWrapper">
          <a href="${productUrl}" class="ais-HitLink">
            <div class="ais-HitContent">
              <div class="ais-HitPicture">
                <img
                  src="${hit.image || hit.image_url}"
                  alt="${hit.title}"
                  loading="lazy"
                />
              </div>
              <div class="ais-HitContentBody">
                <div class="ais-HitVendor">
                  ${components.Highlight({ hit, attribute: 'vendor' })}
                </div>
                <div class="ais-HitTitle">
                  ${components.Highlight({ hit, attribute: 'title' })}
                </div>
             
                <div class="ais-HitPrice">
                          ${price ? html`$${price}` : ''}
                          ${uom ? html`<span class="aa-ItemUOM"> ${uom}</span>` : ''}
                        </div>
              </div>
            </div>
          </a>
        </div>
      `;
    },
  },
}),

    pagination({
      container: '#pagination',
    }),

    configure({
      hitsPerPage: 30,
    }),
  ]);

  search.start();

      // Pull ?q=... from the URL and sync with InstantSearch
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('q');

    if (queryParam) {
      // Set initial query state for InstantSearch
      search.setUiState({
        [indexName]: {
          query: queryParam,
          page: 1,
        },
      });

      // Update the searchbox widget display value
      const searchInput = document.querySelector('#searchbox input[type="search"], #searchbox input[type="text"]');
      if (searchInput) {
        searchInput.value = queryParam;
      }
    }


    document.addEventListener('click', (e) => {
        const header = e.target.closest('.ais-Panel-header');
        if (!header) return;

        const panel = header.closest('.ais-Panel');
        if (!panel) return;

        panel.classList.toggle('ais-Panel--collapsed');
    });
});
</script>