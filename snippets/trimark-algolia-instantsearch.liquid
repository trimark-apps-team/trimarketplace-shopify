<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@8.5.1/themes/reset-min.css" integrity="sha256-KvFgFCzgqSErAPu6y9gz/AhZAvzK48VJASu3DpNLCEQ=" crossorigin="anonymous">
<link
  rel="stylesheet"
  href="{{ 'trimark-algolia-instantsearch-overrides.css' | asset_url }}"
>
<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const { algoliasearch, instantsearch, widgets } = algoliaShopify.externals;

  // Destructure widgets from the top-level `widgets` object (not instantsearch.widgets)
  const {
    searchBox,
    hits,
    pagination,
    refinementList,
    clearRefinements,
    configure,
    rangeInput
  } = widgets;

  const searchClient =
    algoliaShopify.searchClient ||
    algoliasearch(
      algoliaShopify.config.app_id,
      algoliaShopify.config.search_api_key
    );

  const indexName = `${algoliaShopify.config.index_prefix}products`;

  const search = instantsearch({
    indexName,
    searchClient,
  });



  // ✅ Don't use instantsearch.widgets.* — use the destructured widget functions directly.
  search.addWidgets([
    searchBox({
      container: '#searchbox',
      placeholder: 'Search products...',
    }),

    clearRefinements({
      container: '#clear-refinements',
    }),

  widgets.panel({
    templates: { header: 'Brand' },
    collapsed: () => true,
  })(widgets.refinementList)({
    container: '#brand-list',
    attribute: 'vendor',
  }),

widgets.panel({
  templates: { header: 'Product Type' },
})(widgets.refinementList)({
  container: '#product-type',
  attribute: 'product_type',
  limit: 20,            // show 20 types initially
  showMore: true,       // enable "Show more" button
  showMoreLimit: 100,   // max total when expanded
}),

  widgets.panel({
    templates: { header: 'Tags' },
  })(widgets.refinementList)({
    container: '#tags',
    attribute: 'tags',
  }),

  widgets.panel({
    templates: { header: 'Price Range' },
  })(widgets.refinementList)({
    container: '#price-range',
    attribute: 'price_range',
    sortBy: (a, b) => {
      const getStart = (label) => parseFloat(label.split(':')[0]) || 0;
      return getStart(a.name) - getStart(b.name);
    },
    limit: 10,
    showMore: true,
    showMoreLimit: 30,
    templates: {
      item(item, { html }) {
        const label = item.label.includes(':')
          ? item.label
              .split(':')
              .map((v, i) =>
                i === 0 ? `$${v.trim()}` : v ? `$${v.trim()}` : '+'
              )
              .join(' – ')
          : `$${item.label}`;
        return html`
          <label class="ais-RefinementList-label">
            <input
              type="checkbox"
              class="ais-RefinementList-checkbox"
              ${item.isRefined ? 'checked' : ''}
            />
            <span class="ais-RefinementList-labelText">${label}</span>
            <span class="ais-RefinementList-count">${item.count}</span>
          </label>
        `;
      },
    },
  }),
    widgets.sortBy({
    container: '#sort-by',
    items: [
        { label: 'Relevance', value: `${indexName}` },
        { label: 'Price (asc)', value: `${indexName}_price_asc` },
        { label: 'Price (desc)', value: `${indexName}_price_desc` },
    ],
    }),


    hits({
      container: '#hits',
      templates: {
        item(hit) {
          return `
            <a href="/products/${hit.handle}">
              <img src="${hit.image || hit.image_url}" alt="${hit.title}" width="150" />
              <h3>${instantsearch.highlight({ attribute: 'title', hit })}</h3>
              <p>${hit.price}</p>
            </a>
          `;
        },
      },
    }),

    pagination({
      container: '#pagination',
    }),

    configure({
      hitsPerPage: 8,
    }),
  ]);

  search.start();


    document.addEventListener('click', (e) => {
        const header = e.target.closest('.ais-Panel-header');
        if (!header) return;

        const panel = header.closest('.ais-Panel');
        if (!panel) return;

        panel.classList.toggle('ais-Panel--collapsed');
    });
});
</script>