

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@8.5.1/themes/reset-min.css" integrity="sha256-KvFgFCzgqSErAPu6y9gz/AhZAvzK48VJASu3DpNLCEQ=" crossorigin="anonymous">
<link
  rel="stylesheet"
  href="{{ 'trimark-algolia-instantsearch-overrides.css' | asset_url }}"
>
<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const { algoliasearch, instantsearch, widgets, connectors } = algoliaShopify.externals;
  // Destructure widgets from the top-level `widgets` object (not instantsearch.widgets)
  const {
    searchBox,
    hits,
    pagination,
    refinementList,
    clearRefinements,
    configure,
    rangeInput,
    panel
  } = widgets;

   const { connectCurrentRefinements } = connectors;
  

  const searchClient =
    algoliaShopify.searchClient ||
    algoliasearch(
      algoliaShopify.config.app_id,
      algoliaShopify.config.search_api_key
    );

  const indexName = `${algoliaShopify.config.index_prefix}products`;

const customCurrentRefinements = connectCurrentRefinements(
  (renderOptions, isFirstRender) => {
    const { items, refine } = renderOptions;

    const container = document.querySelector('#selected-filters');
    if (isFirstRender) {
      container.innerHTML = `
        <div class="ais-CurrentRefinements">
          <ul class="ais-CurrentRefinements-list"></ul>
        </div>
      `;
    }

    const list = container.querySelector('.ais-CurrentRefinements-list');
    list.innerHTML = items
      .map((group) => {
        // normalize attribute labels
        let attributeLabel = group.attribute.replace(/_/g, ' ');
        if (group.attribute === 'inventory_available') attributeLabel = 'Availability';
        if (group.attribute === 'meta.custom.12_color') attributeLabel = 'Colors';
        if (group.attribute === 'meta.custom.6_brand') attributeLabel = 'Brand';
        if (group.attribute === 'meta.custom.5_non_stock') attributeLabel = 'Non Stock';

        const refinementsHtml = group.refinements
          .map((refinement) => {
            let label = refinement.label.replace(':', '–');

            // translate inventory_available labels
            if (group.attribute === 'inventory_available') {
              const raw = refinement.label ?? refinement.value;
              const isTrue =
                raw === true || raw === 'true' || raw === 1 || raw === '1';
              label = isTrue ? 'In Stock' : 'Out of Stock';
            }

            return `
              <span class="ais-CurrentRefinements-label">
                ${label}
                <button class="ais-CurrentRefinements-remove"
                  data-attribute="${group.attribute}"
                  data-label="${refinement.label}">
                  ×
                </button>
              </span>`;
          })
          .join('');

        return `
          <li class="ais-CurrentRefinements-item">
            <strong>${attributeLabel}</strong>:
            ${refinementsHtml}
          </li>`;
      })
      .join('');

    list.querySelectorAll('.ais-CurrentRefinements-remove').forEach((btn) => {
      const attr = btn.dataset.attribute;
      const label = btn.dataset.label;
      const group = items.find((g) => g.attribute === attr);
      const refinement = group?.refinements.find((r) => r.label === label);
      if (refinement) {
        btn.onclick = () => refine(refinement);
      }
    });
  }
);
  const search = instantsearch({
    indexName,
    searchClient,
    routing: {
    stateMapping: {
      stateToRoute(uiState) {
        return {
          query: uiState[indexName]?.query || '',
          page: uiState[indexName]?.page || 1,
        };
      },
      routeToState(routeState) {
        return {
          [indexName]: {
            query: routeState.query || '',
            page: routeState.page || 1,
          },
        };
      },
    },
  },
});

  search.addWidgets([
    searchBox({
      container: '#searchbox',
      placeholder: 'Search Products...',
  }),
    clearRefinements({
    container: '#clear-refinements',
    templates: {
      resetLabel: 'Clear all',
    },
    cssClasses: {
      button: 'ais-CurrentRefinements-clearAll',
    },
  }),

  customCurrentRefinements({
    container: document.querySelector('#current-refinements'),
  }),

widgets.panel({
  templates: { header: 'Brand' },
})(widgets.refinementList)({
  container: '#brand-list',
  attribute: 'meta.custom.6_brand',
  sortBy: ['name:asc'],
  limit: 15,
  showMore: true
}),

 {% comment %} widgets.panel({
  templates: { header: 'Collections' },
})(widgets.refinementList)({
  container: '#collections-list',
  attribute: 'collections',
  transformItems(items) {
    return items.map((item) => {
      const pretty = item.label
        .replace(/-/g, ' ')
        .replace(/\b\w/g, (c) => c.toUpperCase());
      return {
        ...item,
        label: pretty,
        highlighted: pretty, // refinementList may render this
      };
    });
  },
}), {% endcomment %}

widgets.panel({
  templates: { header: 'Colors' },
})(widgets.refinementList)({
  container: '#colors',
  attribute: 'meta.custom.12_color',
  sortBy: ['name:asc'],
  limit: 15,
  showMore: true      // enable "Show more" button
}),

widgets.panel({
  templates: { header: 'Non Stock' },
})(widgets.refinementList)({
  container: '#non-stock',
  attribute: 'meta.custom.5_non_stock',
  sortBy: ['name:desc'],
}),


{% comment %} widgets.panel({
  templates: { header: 'Availability' },
})(widgets.refinementList)({
  container: '#inventory-available',
  attribute: 'inventory_available',
  transformItems(items) {
    return items.map((item) => {
      const raw = item.label ?? item.value;
      const isTrue =
        raw === true || raw === 'true' || raw === 1 || raw === '1';
      const pretty = isTrue ? 'In Stock' : 'Out of Stock';
      return {
        ...item,
        label: pretty,        // used by most templates
        highlighted: pretty,  // used when the widget renders the highlighted label
      };
    });
  },
}), {% endcomment %}

widgets.panel({
  templates: { header: 'Product Type' },
})(widgets.refinementList)({
  container: '#product-type',
  attribute: 'product_type',
  sortBy: ['name:asc'],
  limit: 15,            // show 20 types initially
  showMore: true       // enable "Show more" button
}),

{% comment %} widgets.panel({
  templates: { header: 'Price Range' },
})(widgets.refinementList)({
  container: '#price-range',
  attribute: 'price_range',
  sortBy: (a, b) => {
    const start = (s) => parseFloat(String(s).split(':')[0]) || 0;
    return start(a.name) - start(b.name);
  },
  limit: 10,
  showMore: true,
  showMoreLimit: 30,

  // If you enabled searchable: true at any point, the widget will prefer
  // `item.highlighted`. We format all possible fields to be safe.
  transformItems(items) {
    const fmt = (raw) => {
      if (!raw) return '';
      if (!String(raw).includes(':')) return `$${raw}`;
      const [lo, hi] = String(raw).split(':').map(s => s.trim());
      return hi ? `$${lo} – $${hi}` : `$${lo} +`;
    };

    return items.map((item) => {
      const label = fmt(item.label ?? item.name ?? item.value);
      return {
        ...item,
        label,          // used by default renderer
        name: label,    // used by chips / some render paths
        highlighted: label, // used when searchable is on
      };
    });
  },
}), {% endcomment %}

 widgets.sortBy({
  container: '#sort-by',
  items: [
    {% comment %} { label: 'Price (asc)', value: `${indexName}_price_asc` }, {% endcomment %}
    { label: 'Relevance', value: `${indexName}` },
    {% comment %} { label: 'Price (desc)', value: `${indexName}_price_desc` }, {% endcomment %}
  ],
}),


hits({
  container: '#hits',
  templates: {
    item(hit, { html, components }) {
      const productUrl = hit.url || `/products/${hit.handle}`;
      const price = hit.price;
      const uom = hit.meta?.custom?.['3_uom'] || '';

      return html`
        <div class="ais-HitWrapper">
          <a href="${productUrl}" class="ais-HitLink">
            <div class="ais-HitContent">
              <div class="ais-HitPicture">
                <img
                  src="${hit.image || hit.image_url}"
                  alt="${hit.title}"
                  loading="lazy"
                />
              </div>
              <div class="ais-HitContentBody">
                <div class="ais-HitVendor">
                  ${components.Highlight({ hit, attribute: 'vendor' })}
                </div>
                <div class="ais-HitTitle">
                  ${components.Highlight({ hit, attribute: 'title' })}
                </div>
             
                <!-- 
                <div class="ais-HitPrice">
                          ${price ? html`$${price}` : ''}
                          ${uom ? html`<span class="aa-ItemUOM"> ${uom}</span>` : ''}
                </div>
                  -->
              </div>
            </div>
          </a>
        </div>
      `;
    },
  },
}),

    pagination({
      container: '#pagination',
    }),

    configure({
      hitsPerPage: 30,
    }),
  ]);

  search.start();

      // Pull ?q=... from the URL and sync with InstantSearch
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('q');

    if (queryParam) {
      // Set initial query state for InstantSearch
      search.setUiState({
        [indexName]: {
          query: queryParam,
          page: 1,
        },
      });

      // Update the searchbox widget display value
      const searchInput = document.querySelector('#searchbox input[type="search"], #searchbox input[type="text"]');
      if (searchInput) {
        searchInput.value = queryParam;
      }
    }


    document.addEventListener('click', (e) => {
        const header = e.target.closest('.ais-Panel-header');
        if (!header) return;

        const panel = header.closest('.ais-Panel');
        if (!panel) return;

        panel.classList.toggle('ais-Panel--collapsed');
    });
});
</script>