<div class="quick-order-controls page-width">
  <div class="quick-order-controls__inner">
  <button id="cart-click" class="button"><span class="cart-items_count"> CART ({{ cart.items.size }} PRODUCTS, {{ cart.item_count }} QUANTITIES)</span></button>
  <button id="cart-clear" class="button">CLEAR CART</button>
      <button id="download-collection-file" class="button hidden">DOWNLOAD FILE</button>
    <button id="add-collection-to-cart" class="button hidden">ADD COLLECTION TO CART</button>
  </div>
  
  <div class="quick-order-controls__inner">
    <input
      type="text"
      id="quick-order-search"
      placeholder="Search by title, type, SKU and Item Number"
      class="quick-order-search-input"
    >

    <select id="quick-order-sort" class="quick-order-sort-select">
      <option value="recent">Recently Purchased</option>
      <option value="az">Title: A → Z</option>
      <option value="za">Title: Z → A</option>
    </select>

    {% comment %} <div class="dropdown-collection">
      <input type="text" id="collection-search" placeholder="Search collections..." class="collection-search-input">
      <div class="dropdown-menu hidden">
        <div id="quick-order-collections" class="quick-order-collections">
          {% for collection in collections %}
            {% unless collection.title == "Best selling" %}
              <label>
                <input type="checkbox" class="collection-filter" value="{{ collection.handle }}" data-title="{{ collection.title }}" data-download="{{ collection.metafields.custom.download_file | file_url }}">
                {{ collection.title }}
              </label>
            {% endunless %}
          {% endfor %}
        </div>
      </div>
    </div>
    <button class="active-collection__button button hidden">
      <span class="collection-title"></span>
      <span class="svg-wrapper">
         {{- 'icon-close.svg' | inline_asset_content -}}
       </span>
     </button> {% endcomment %}
  </div>
</div>

<div class="quick-order_loader"></div> 

<div class="quick-order-list-container">
  <quick-order-list class="page-width">
    <div class="quick-order-list__container hidden" id="main-variant-items">
      <table class="quick-order-list__table">
        <thead class="">
                    <tr>
                      <th class="caption-with-letter-spacing" scope="col">
                       Item
                      </th>
                      <th class="large-up-hide right caption-with-letter-spacing" scope="col">Variant total </th>
                      <th class="quick-order-list__table-heading--wide small-hide medium-hide caption-with-letter-spacing" scope="col" style="text-align: center; padding-left: 0;">
                      Quantity
                      </th>
                      <th class="quick-order-list__table-heading--wide small-hide medium-hide caption-with-letter-spacing" scope="col" style="text-align: center; padding-left: 0;">
                      Action
                      </th> 
                      <th class="quick-order-list__table-heading--wide small-hide medium-hide caption-with-letter-spacing" scope="col">
                       Price
                      </th>
                      <th class="small-hide medium-hide right caption-with-letter-spacing" scope="col">
                        Item Total
                      </th>
                    </tr>
                  </thead>
        <tbody id="quick-order-products"></tbody>
      </table>
    </div>
  </quick-order-list>
</div>

<div id="quick-order-pagination" class="pagination-controls hidden">
  <button id="prev-page" disabled>Prev</button>
  <span id="page-info"></span>
  <button id="next-page">Next</button>
</div>

<div id="no-results" class="no-results-message hidden">No products found matching your search.</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  const searchInput = document.getElementById('quick-order-search');
  const sortSelect = document.getElementById('quick-order-sort');
  const container = document.getElementById('quick-order-products');
  const pagination = document.getElementById('quick-order-pagination');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageInfoEl = document.getElementById('page-info');
  const noResults = document.getElementById('no-results');
  const cartClear = document.querySelector("#cart-clear");

  const ITEMS_PER_PAGE = 20;
  const DOMAIN = '{{ shop.permanent_domain }}';
  const LOCATIONID = "{{ customer.current_location.id }}";

  let currentPageInfo = null;

  function showLoader(show = true) {
    document.querySelector("#main-variant-items")
      ?.classList.toggle("hidden", show);
    document.querySelector(".quick-order_loader")
      ?.classList.toggle("hidden", !show);
  }

  /* ----------------------------------------
     API FETCH
  ---------------------------------------- */
  async function fetchProducts({
    after = null,
    before = null,
    direction = 'next'
  } = {}) {

    const params = new URLSearchParams();
    params.set('domain', DOMAIN);
    params.set('companyLocationId', LOCATIONID);

    if (direction === 'prev' && before) {
      params.set('last', ITEMS_PER_PAGE);
      params.set('before', before);
    } else {
      params.set('first', ITEMS_PER_PAGE);
      if (after) params.set('after', after);
    }

    const search = searchInput.value?.trim();
    if (search) params.set('search', search);

    const sort = sortSelect.value;
    if (sort) params.set('sort', sort);

    showLoader(true);
    const res = await fetch(`/apps/api/get-products-custom?${params.toString()}`);
    const data = await res.json();
    showLoader(false);

    return data;
  }

  /* ----------------------------------------
     RENDER
  ---------------------------------------- */
  function createProductRow(product) {
    const variant = product.variant;
    if (!variant) return null;

    const orderedDate = product.purchasedDate
      ? new Date(product.purchasedDate).toLocaleDateString('en-US')
      : '';

    const tr = document.createElement('tr');
    tr.className = 'variant-item';
    tr.dataset.variantId = variant.idNumeric;

    tr.innerHTML = `
<td class="variant-item__inner">
  <div class="variant-item__media">
    <div class="variant-item__image-container global-media-settings gradient">
      <img src="${product.featuredImageUrl}" alt="${product.title}" width="43" height="43" loading="lazy" fetchpriority="low" decoding="async" class="variant-item__image">
    </div>
  </div>
  <div class="small-hide medium-hide">
    <span class="variant-item__name h4 break"><a class="full-unstyled-link" href="/products/${product.handle}">${product.title}</a></span>
    <span class="variant-item__sku break">${variant.sku ? `${variant.sku} ${orderedDate ? ` | <span class="color-red">Last ordered: ${orderedDate}</span>` : ""}` : `${orderedDate ? `<span class="color-red">Last ordered: ${orderedDate}</span>` : ""}`}</span>
  </div>
</td>
<td class="variant-item__details large-up-hide">
  <div class="variant-item__info">
    <span class="variant-item__name h4 break"><a class="full-unstyled-link" href="/products/${product.handle}">${product.title}</a></span>
    <span class="variant-item__sku break">${variant.sku ? `${variant.sku} ${orderedDate ? ` | <span class="color-red">Last ordered: ${orderedDate}</span>` : ""}` : `${orderedDate ? `<span class="color-red">Last ordered: ${orderedDate}</span>` : ""}`}</span>
  </div>
  <span class="price">$${variant.price}</span>
</td>
<td class="variant-item__totals right large-up-hide">
  <div class="loading__spinner hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
  </div>
  <span class="price">$0</span>
</td>

<td class="variant-item__quantity">
  <quantity-popover>
    <div class="variant-item__quantity-wrapper quantity-popover-wrapper variant-item__quantity-wrapper--no-info">
      <label class="visually-hidden">Quantity</label>
      <div class="quantity-popover-container">
        <quantity-input class="quantity cart-quantity">
<button class="quantity__button disabled" name="minus" type="button">
    <span class="visually-hidden">Decrease quantity for Default Title</span>
    <span class="svg-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" class="icon icon-minus" viewBox="0 0 10 2"><path fill="currentColor" fill-rule="evenodd" d="M.5 1C.5.7.7.5 1 .5h8a.5.5 0 1 1 0 1H1A.5.5 0 0 1 .5 1" clip-rule="evenodd"></path></svg>
</span>
  </button>
          <input type="number" class="quantity__input" value="1" min="1" />
<button class="quantity__button" name="plus" type="button">
    <span class="visually-hidden">Increase quantity for Default Title</span>
    <span class="svg-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" class="icon icon-plus" viewBox="0 0 10 10"><path fill="currentColor" fill-rule="evenodd" d="M1 4.51a.5.5 0 0 0 0 1h3.5l.01 3.5a.5.5 0 0 0 1-.01V5.5l3.5-.01a.5.5 0 0 0-.01-1H5.5L5.49.99a.5.5 0 0 0-1 .01v3.5l-3.5.01z" clip-rule="evenodd"></path></svg>
</span>
  </button>
          <div class="progress-bar-container hidden">
            <div class="progress-bar"><div class="progress-bar-value"></div></div>
          </div>
        </quantity-input>
        <button class="quick-add__submit button large-up-hide">
          <span>Add to Cart</span>
          <div class="loading__spinner hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
          </div>
        </button>
      </div>
    </div>
    <div class="variant-item__error large-up-hide" role="alert">
      <small class="variant-item__error-text"></small>
    </div>
  </quantity-popover>
</td>
<td class="variant-item__quantity small-hide medium-hide" style="text-align: center; padding-left: 0;">
  <button class="quick-add__submit button">
    <span>Add to Cart</span>
    <div class="loading__spinner hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
    </div>
  </button>
</td>
<td class="variant-item__price small-hide medium-hide"><span class="price">$${variant.price}</span></td>
<td class="variant-item__totals right small-hide medium-hide">
  <div class="loading__spinner hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
  </div>
  <span class="price">$0</span>
</td>
    `;

    return tr;
  }

  function updateRowsWithCart(cart) {
  const rows = container.querySelectorAll('.variant-item');
  rows.forEach(row => {
    const variantId = row.dataset.variantId;
    const cartItem = cart.items.find(i => i.variant_id.toString() === variantId);

    if (cartItem) {

      const totals = row.querySelectorAll('.variant-item__totals .price');
      totals.forEach(totalEl => {
        totalEl.textContent = `$${(cartItem.price * cartItem.quantity / 100).toFixed(2)}`;
      });
    } else {
      const totals = row.querySelectorAll('.variant-item__totals .price');
      totals.forEach(totalEl => {
        totalEl.textContent = "$0";
      });
    }
  });
}

 async function getCart() {
  const res = await fetch('/cart.js');
  return res.json();
  }

  async function render(data) {
    container.innerHTML = '';

    if (!data?.success || !data.items?.length) {
      noResults.classList.remove('hidden');
      pagination.classList.add('hidden');
      return;
    }

    noResults.classList.add('hidden');
    pagination.classList.remove('hidden');

    data.items.forEach(p => {
      const row = createProductRow(p);
      if (row) container.appendChild(row);
    });

    currentPageInfo = data.pageInfo;

    pageInfoEl.textContent = `Showing ${data.items.length} products`;

    prevBtn.disabled = !currentPageInfo.hasPreviousPage;
    nextBtn.disabled = !currentPageInfo.hasNextPage;

  const cart = await getCart();
  updateRowsWithCart(cart);
  }

  function clearCart() {
    fetch('/cart/clear.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
        refreshCart();
        document.querySelector("cart-drawer").classList.add("is-empty");
        const cartCountBubble = document.querySelector('.cart-count-bubble');
        const cartItemsCount = document.querySelector('#cart-click .cart-items_count');
        
        if (cartCountBubble) cartCountBubble.innerText = data.item_count;
        if (cartItemsCount) {
          cartItemsCount.innerText = `CART (${data.items.length} PRODUCTS, ${data.item_count} QUANTITY)`;
        }
        updateRowsWithCart(data);
    })
  }

  cartClear.addEventListener('click', function () {
    clearCart()
  });

  /* ----------------------------------------
     LOADERS
  ---------------------------------------- */
  async function loadInitial() {
    const data = await fetchProducts();
    await render(data);
  }

  const debounce = (fn, d = 300) => {
    let t;
    return (...a) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...a), d);
    };
  };

  /* ----------------------------------------
     EVENTS
  ---------------------------------------- */
  searchInput.addEventListener('input', debounce(loadInitial, 350));
  sortSelect.addEventListener('change', loadInitial);

  nextBtn.addEventListener('click', async () => {
    const data = await fetchProducts({
      after: currentPageInfo?.endCursor,
      direction: 'next'
    });
    await render(data);
  });

  prevBtn.addEventListener('click', async () => {
    const data = await fetchProducts({
      before: currentPageInfo?.startCursor,
      direction: 'prev'
    });
    await render(data);
  });

  /* ----------------------------------------
     INIT
  ---------------------------------------- */
  await loadInitial();
});
</script>
