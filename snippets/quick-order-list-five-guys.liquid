<div class="quick-order-controls page-width">
  <div class="quick-order-controls__inner">
  <button id="cart-click" class="button"><span class="cart-items_count"> CART ({{ cart.items.size }} PRODUCTS, {{ cart.item_count }} QUANTITIES)</span></button>
  <button id="cart-clear" class="button">CLEAR CART</button>
      <button id="download-collection-file" class="button hidden">DOWNLOAD FILE</button>
    <button id="add-collection-to-cart" class="button hidden">ADD COLLECTION TO CART</button>
  </div>
  
  <div class="quick-order-controls__inner">
    <input
      type="text"
      id="quick-order-search"
      placeholder="Search by title, price, type or SKU"
      class="quick-order-search-input"
    >

    <select id="quick-order-sort" class="quick-order-sort-select">
      <option value="recent">Recently Purchased</option>
      <option value="az">Title: A → Z</option>
      <option value="za">Title: Z → A</option>
      <option value="plh">Price: Low → High</option>
      <option value="phl">Price: High → Low</option>
      <option value="inv_low">Inventory: Low → High</option>
      <option value="inv_high">Inventory: High → Low</option>
    </select>

    <div class="dropdown-collection">
      <input type="text" id="collection-search" placeholder="Search collections..." class="collection-search-input">
      <div class="dropdown-menu hidden">
        <div id="quick-order-collections" class="quick-order-collections">
          {% for collection in collections %}
            {% unless collection.title == "Best selling" %}
              <label>
                <input type="checkbox" class="collection-filter" value="{{ collection.handle }}" data-title="{{ collection.title }}" data-download="{{ collection.metafields.custom.download_file | file_url }}">
                {{ collection.title }}
              </label>
            {% endunless %}
          {% endfor %}
        </div>
      </div>
    </div>
    <button class="active-collection__button button hidden">
      <span class="collection-title"></span>
      <span class="svg-wrapper">
         {{- 'icon-close.svg' | inline_asset_content -}}
       </span>
     </button>
  </div>
</div>

<div class="quick-order_loader"></div> 

<div class="quick-order-list-container">
  <quick-order-list class="page-width">
    <div class="quick-order-list__container hidden" id="main-variant-items">
      <table class="quick-order-list__table">
        <thead class="">
                    <tr>
                      <th class="caption-with-letter-spacing" scope="col">
                       Item
                      </th>
                      <th class="large-up-hide right caption-with-letter-spacing" scope="col">Variant total </th>
                      <th class="quick-order-list__table-heading--wide small-hide medium-hide caption-with-letter-spacing" scope="col" style="text-align: center; padding-left: 0;">
                      Quantity
                      </th>
                      <th class="quick-order-list__table-heading--wide small-hide medium-hide caption-with-letter-spacing" scope="col" style="text-align: center; padding-left: 0;">
                      Action
                      </th> 
                      <th class="quick-order-list__table-heading--wide small-hide medium-hide caption-with-letter-spacing" scope="col">
                       Price
                      </th>
                      <th class="small-hide medium-hide right caption-with-letter-spacing" scope="col">
                        Item Total
                      </th>
                    </tr>
                  </thead>
        <tbody id="quick-order-products"></tbody>
      </table>
    </div>
  </quick-order-list>
</div>

<div id="quick-order-pagination" class="pagination-controls hidden">
  <button id="prev-page" disabled>Prev</button>
  <span id="page-info"></span>
  <button id="next-page">Next</button>
</div>

<div id="no-results" class="no-results-message hidden">No products found matching your search.</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  const searchInput = document.getElementById('quick-order-search');
  const sortSelect = document.getElementById('quick-order-sort');
  const collectionCheckboxes = document.querySelectorAll('.collection-filter');
  const collectionSearch = document.getElementById('collection-search');
  const dropdownToggle = collectionSearch;
  const dropdownMenu = document.querySelector('.dropdown-menu');
  const container = document.getElementById('quick-order-products');
  const pagination = document.getElementById('quick-order-pagination');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');
  const noResults = document.getElementById('no-results');
  const activeCollectionBtn = document.querySelector(".active-collection__button");
  const cartClear = document.querySelector("#cart-clear");

  const downloadBtn = document.getElementById('download-collection-file');
  const addCollectionBtn = document.getElementById('add-collection-to-cart');

  const ITEMS_PER_PAGE = 20;
  let currentPage = 1;
  let allProducts = [];
  let filteredProducts = [];
  let selectedCollectionHandle = null;
  let selectedCollectionTitle = null;
  let selectedCollectionDownload = null;

  const modal = document.querySelector('.modal');
  const overlay = document.querySelector('.overlay');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const closeIcon = document.getElementById('close-icon');
  const approverName = document.getElementById('approver-name');

  function showPopup(title, message, approver ,isError = false) {
    modalTitle.innerHTML = title;
    modalMessage.innerHTML = message;
    overlay.style.visibility = 'visible';
    modal.style.display = 'block';
    closeIcon.style.display = 'block';
    approverName.textContent = approver;

    if (isError) {
      modal.classList.add('error');
    } else {
      modal.classList.remove('error');
    }
  }

  dropdownToggle.addEventListener('focus', () => dropdownMenu.classList.remove('hidden'));
  activeCollectionBtn.addEventListener("click", function () {
     collectionCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.dispatchEvent(new Event("change")); 
      });
  });

  document.addEventListener("click", e => {
    if (!dropdownMenu.contains(e.target) && e.target !== dropdownToggle) {
      dropdownMenu.classList.add('hidden');
    }
  });

  collectionSearch.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    document.querySelectorAll('#quick-order-collections label').forEach(label => {
      label.style.display = label.textContent.toLowerCase().includes(val) ? '' : 'none';
    });
  });

  collectionCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      collectionCheckboxes.forEach(other => { if (other !== cb) other.checked = false; });
      if (cb.checked) {
        selectedCollectionHandle = cb.value;
        if(cb.value == "new-store-opening-1" || cb.value == "new-store-opening-2") {
          selectedCollectionDownload = cb.dataset.download;
          selectedCollectionTitle = cb.dataset.title;
          downloadBtn.classList.remove('hidden');
          addCollectionBtn.classList.remove('hidden');
        } else {
          downloadBtn.classList.add('hidden');
          addCollectionBtn.classList.add('hidden');
        }
          document.querySelector(".active-collection__button .collection-title").innerText = cb.dataset.title;
          document.querySelector(".active-collection__button").classList.remove("hidden");
      } else {
        selectedCollectionHandle = null;
        selectedCollectionDownload = null;
        selectedCollectionTitle = null;
        downloadBtn.classList.add('hidden');
        addCollectionBtn.classList.add('hidden');
        document.querySelector(".active-collection__button").classList.add("hidden");
      }
      applyFilters();
    });
  });

  downloadBtn.addEventListener('click', () => {
    console.log("selectedCollectionDownload", selectedCollectionDownload)
    if (!selectedCollectionDownload) return;
    const link = document.createElement('a');
    link.href = selectedCollectionDownload;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    link.remove();
  });

  function refreshCart() {
  const cartDrawer = document.getElementById('CartDrawer');

  if (cartDrawer || quickOrderForm) {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', window.location.href);
    xhr.onload = () => {
      if (xhr.status === 200) {
        const parser = new DOMParser();
        const responseDoc = parser.parseFromString(xhr.responseText, 'text/html');

        if (cartDrawer) {
          const newDrawer = responseDoc.querySelector('#CartDrawer');
          if (newDrawer) cartDrawer.innerHTML = newDrawer.innerHTML;
        }

      }
    };
    xhr.send();
  }
}

 function clearCart() {
    fetch('/cart/clear.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
        refreshCart();
        document.querySelector("cart-drawer").classList.add("is-empty");
        const cartCountBubble = document.querySelector('.cart-count-bubble');
        const cartItemsCount = document.querySelector('#cart-click .cart-items_count');
        
        if (cartCountBubble) cartCountBubble.innerText = data.item_count;
        if (cartItemsCount) {
          cartItemsCount.innerText = `CART (${data.items.length} PRODUCTS, ${data.item_count} QUANTITY)`;
        }
        updateRowsWithCart(data);
    })
  }

  cartClear.addEventListener('click', function () {
    clearCart()
  });


  addCollectionBtn.addEventListener('click', async () => {

    const productsToAdd = allProducts
  .filter(p => p.collections?.edges.some(c => c.node.handle === selectedCollectionHandle))
  .map(p => {
    const variant = p.variants.edges[0]?.node;
    if (!variant) return null;
    const quantity = parseInt(p.quantitySet?.value || 1);
    return {
      id: variant.id.split("/").pop(),
      quantity
    };
  })
  .filter(Boolean);

    if (productsToAdd.length === 0) return;


    showPopup(
            `Adding <b>${selectedCollectionTitle}</b> collection to the cart.`,
            `Total items:- ${productsToAdd.length}`,
            ``
     );
    try {
      const res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: productsToAdd })
      })

      const data = await res.json();
    
    refreshCart();
    
    if(document.querySelector("cart-drawer")?.classList.contains("is-empty")) {
      document.querySelector("cart-drawer").classList.remove("is-empty");
    }
    
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        const cartCountBubble = document.querySelector('.cart-count-bubble');
        const cartItemsCount = document.querySelector('#cart-click .cart-items_count');
        
        if (cartCountBubble) cartCountBubble.innerText = cart.item_count;
        if (cartItemsCount) {
          cartItemsCount.innerText = `CART (${cart.items.length} PRODUCTS, ${cart.item_count} QUANTITY)`;
        }
        updateRowsWithCart(cart);
      });

      document.querySelector('.spinner-wrapper').style.display = 'none';

       showPopup(
            `Successfully added <b>${selectedCollectionTitle}</b> collection to the cart.`,
            `Total items:- ${productsToAdd.length}`,
            ``
        );

    
    } catch (error) {
      console.error('Error adding collection to cart:', error);
      alert('Failed to add collection to cart.');
    }
  });

    async function fetchProducts(companyLocationId, domain) {
      let cursor = null;
      const products = [];
      const seenProductIds = new Set(); 
      let isFirstCall = true;

      do {
        const first = isFirstCall ? 250 : 100;
        const url = `/apps/api/get-company-location-products?companyLocationId=${companyLocationId}&domain=${domain}&first=${first}${cursor ? `&after=${cursor}` : ''}`;
        
        const res = await fetch(url);
        const data = await res.json();
        if (!data.success) break;

        const catalogs = data.data.companyLocation.catalogs.edges;

        catalogs.forEach(c => {
          const productsEdges = c.node.publication?.products?.edges || [];

          productsEdges.forEach(p => {
            const node = p.node;

            const url = node?.onlineStoreUrl || "";
            if (url.includes("products_preview")) return;

            if (seenProductIds.has(node.id)) return;

            seenProductIds.add(node.id);

            node.recent = node.purchasedDate?.value
              ? new Date(node.purchasedDate.value).toISOString()
              : "1970-01-01T00:00:00Z";

            products.push(node);
          });
        });

        const lastCatalog = catalogs[catalogs.length - 1];
        const pageInfo = lastCatalog?.node.publication?.products?.pageInfo;
        cursor = pageInfo?.hasNextPage ? pageInfo.endCursor : null;

        isFirstCall = false;
      } while (cursor);

      return products;
    }


  function createProductRow(product) {
    const variant = product.variants.edges[0]?.node;
    if (!variant) return null;

    const row = document.createElement('tr');
    row.classList.add('variant-item');
    row.dataset.variantId = variant.id.split("/").pop();
    row.dataset.title = product.title.toLowerCase();
    row.dataset.price = variant.price;
    row.dataset.inventory = variant.inventoryQuantity;
    row.dataset.type = product.productType.toLowerCase();
    row.dataset.collection = product.tags.join(',').toLowerCase();
    row.dataset.sku = variant.sku.toLowerCase();
    row.dataset.recent = product.recent;
    row.dataset.collection = product.collections?.edges
      .map(c => c.node.handle.toLowerCase())
      .join(',');

    const orderedDate = product.purchasedDate?.value
      ? new Date(product.purchasedDate.value).toLocaleDateString('en-US')
      : "";

    row.innerHTML = `
<td class="variant-item__inner">
  <div class="variant-item__media">
    <div class="variant-item__image-container global-media-settings gradient">
      <img src="${product.featuredMedia?.preview?.image?.url}" alt="${product.title}" width="43" height="43" loading="lazy" fetchpriority="low" decoding="async" class="variant-item__image">
    </div>
  </div>
  <div class="small-hide medium-hide">
    <span class="variant-item__name h4 break"><a class="full-unstyled-link" href="/products/${product.handle}">${product.title}</a></span>
    <span class="variant-item__sku break">${variant.sku ? `${variant.sku} ${orderedDate ? ` | <span class="color-red">Last ordered: ${orderedDate}</span>` : ""}` : `${orderedDate ? `<span class="color-red">Last ordered: ${orderedDate}</span>` : ""}`}</span>
  </div>
</td>
<td class="variant-item__details large-up-hide">
  <div class="variant-item__info">
    <span class="variant-item__name h4 break"><a class="full-unstyled-link" href="/products/${product.handle}">${product.title}</a></span>
    <span class="variant-item__sku break">${variant.sku ? `${variant.sku} ${orderedDate ? ` | <span class="color-red">Last ordered: ${orderedDate}</span>` : ""}` : `${orderedDate ? `<span class="color-red">Last ordered: ${orderedDate}</span>` : ""}`}</span>
  </div>
  <span class="price">$${variant.price}</span>
</td>
<td class="variant-item__totals right large-up-hide">
  <div class="loading__spinner hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
  </div>
  <span class="price">$0</span>
</td>

<td class="variant-item__quantity">
  <quantity-popover>
    <div class="variant-item__quantity-wrapper quantity-popover-wrapper variant-item__quantity-wrapper--no-info">
      <label class="visually-hidden">Quantity</label>
      <div class="quantity-popover-container">
        <quantity-input class="quantity cart-quantity">
<button class="quantity__button disabled" name="minus" type="button">
    <span class="visually-hidden">Decrease quantity for Default Title</span>
    <span class="svg-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" class="icon icon-minus" viewBox="0 0 10 2"><path fill="currentColor" fill-rule="evenodd" d="M.5 1C.5.7.7.5 1 .5h8a.5.5 0 1 1 0 1H1A.5.5 0 0 1 .5 1" clip-rule="evenodd"></path></svg>
</span>
  </button>
          <input type="number" class="quantity__input" value="1" min="1" />
<button class="quantity__button" name="plus" type="button">
    <span class="visually-hidden">Increase quantity for Default Title</span>
    <span class="svg-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" class="icon icon-plus" viewBox="0 0 10 10"><path fill="currentColor" fill-rule="evenodd" d="M1 4.51a.5.5 0 0 0 0 1h3.5l.01 3.5a.5.5 0 0 0 1-.01V5.5l3.5-.01a.5.5 0 0 0-.01-1H5.5L5.49.99a.5.5 0 0 0-1 .01v3.5l-3.5.01z" clip-rule="evenodd"></path></svg>
</span>
  </button>
          <div class="progress-bar-container hidden">
            <div class="progress-bar"><div class="progress-bar-value"></div></div>
          </div>
        </quantity-input>
        <button class="quick-add__submit button large-up-hide">
          <span>Add to Cart</span>
          <div class="loading__spinner hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
          </div>
        </button>
      </div>
    </div>
    <div class="variant-item__error large-up-hide" role="alert">
      <small class="variant-item__error-text"></small>
    </div>
  </quantity-popover>
</td>
<td class="variant-item__quantity small-hide medium-hide" style="text-align: center; padding-left: 0;">
  <button class="quick-add__submit button">
    <span>Add to Cart</span>
    <div class="loading__spinner hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
    </div>
  </button>
</td>
<td class="variant-item__price small-hide medium-hide"><span class="price">$${variant.price}</span></td>
<td class="variant-item__totals right small-hide medium-hide">
  <div class="loading__spinner hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="spinner" viewBox="0 0 66 66"><circle stroke-width="6" cx="33" cy="33" r="30" fill="none" class="path"></circle></svg>
  </div>
  <span class="price">$0</span>
</td>
    `;
    return row;
  }

  function applyFilters() {
    const searchVal = searchInput.value.toLowerCase();
    const sortVal = sortSelect.value;

    filteredProducts = allProducts.filter(p => {
      const title = p.title.toLowerCase();
      const type = p.productType.toLowerCase();
      const sku = p.variants.edges[0]?.node.sku.toLowerCase() || '';
      const price = p.variants.edges[0]?.node.price || '';
      const productCollections = p.collections?.edges.map(c => c.node.handle.toLowerCase()) || [];

      const matchesSearch =
        title.includes(searchVal) ||
        sku.includes(searchVal) ||
        price.includes(searchVal) ||
        type.includes(searchVal) ||
        productCollections.some(c => c.includes(searchVal));

      const matchesCollection =
        !selectedCollectionHandle || productCollections.includes(selectedCollectionHandle.toLowerCase());

      return matchesSearch && matchesCollection;
    });

    filteredProducts.sort((a, b) => {
      const aVar = a.variants.edges[0]?.node;
      const bVar = b.variants.edges[0]?.node;
      switch (sortVal) {
        case 'az': return a.title.localeCompare(b.title);
        case 'za': return b.title.localeCompare(a.title);
        case 'plh': return parseFloat(aVar?.price || 0) - parseFloat(bVar?.price || 0);
        case 'phl': return parseFloat(bVar?.price || 0) - parseFloat(aVar?.price || 0);
        case 'recent': return new Date(b.recent) - new Date(a.recent);
        case 'inv_low': return (aVar?.inventoryQuantity || 0) - (bVar?.inventoryQuantity || 0);
        case 'inv_high': return (bVar?.inventoryQuantity || 0) - (aVar?.inventoryQuantity || 0);
      }
    });

    currentPage = 1;
    renderPage();
  }

  async function getCart() {
  const res = await fetch('/cart.js');
  return res.json();
  }

  async function renderPage() {
  container.innerHTML = '';
  const start = (currentPage - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  const paginatedProducts = filteredProducts.slice(start, end);

  if (paginatedProducts.length === 0) {
    noResults.classList.remove('hidden');
    pagination.style.display = 'none';
  } else {
    noResults.classList.add('hidden');
    pagination.style.display = 'flex';

    paginatedProducts.forEach(p => {
      const row = createProductRow(p);
      if (row) container.appendChild(row);
    });
  }

  pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(filteredProducts.length / ITEMS_PER_PAGE)}`;
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage === Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);
  document.querySelector(".quick-order_loader").classList.add("hidden");
  document.querySelector("#main-variant-items").classList.remove("hidden");
  pagination.classList.remove("hidden");

  const cart = await getCart();
  updateRowsWithCart(cart);
}

function updateRowsWithCart(cart) {
  const rows = container.querySelectorAll('.variant-item');
  rows.forEach(row => {
    const variantId = row.dataset.variantId;
    const cartItem = cart.items.find(i => i.variant_id.toString() === variantId);

    if (cartItem) {

      {% comment %} const qtyInput = row.querySelector('.quantity__input');
      if (qtyInput) qtyInput.value = cartItem.quantity; {% endcomment %}

      const totals = row.querySelectorAll('.variant-item__totals .price');
      totals.forEach(totalEl => {
        totalEl.textContent = `$${(cartItem.price * cartItem.quantity / 100).toFixed(2)}`;
      });
    } else {
      const totals = row.querySelectorAll('.variant-item__totals .price');
      totals.forEach(totalEl => {
        totalEl.textContent = "$0";
      });
    }
  });
}

  function debounce(func, delay) {
    let timer;
    return function (...args) {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    }
  }

  searchInput.addEventListener('input', debounce(applyFilters, 300));
  sortSelect.addEventListener('change', applyFilters);
  collectionCheckboxes.forEach(cb => cb.addEventListener('change', applyFilters));
  prevBtn.addEventListener('click', () => { currentPage--; renderPage(); });
  nextBtn.addEventListener('click', () => { currentPage++; renderPage(); });

  const COMPANY_LOCATION_ID = '{{ customer.current_location.id }}';
  const DOMAIN = '{{ shop.permanent_domain }}';
  allProducts = await fetchProducts(COMPANY_LOCATION_ID, DOMAIN);
  applyFilters();
});
</script>
