if(window.approval_required || String(window.buyer_role).includes("Sales Rep")) {

function checkAndToggleCheckoutButtons(cart) {
    if (!cart) return;

   const approvalRequired = cart.total_price >= window.draftorder_threshold;

    const checkoutButtons = document.querySelectorAll('button[name="checkout"]');
    for (const btn of checkoutButtons) {
      if (approvalRequired) {
        btn.classList.add("hidden");
        document.querySelector('button[data-show-go-to-checkout-param="true"]')?.classList.add("hidden");
        document.querySelectorAll("#create-draft-order").forEach(el => {
          el.classList.remove("hidden");
        });
      } else {
        document.querySelectorAll("#create-draft-order").forEach(el => {
          el.classList.add("hidden");
        });
        document.querySelector('button[data-show-go-to-checkout-param="true"]')?.classList.remove("hidden");
        btn.classList.remove("hidden");
      }
    }
}
function refreshCart() {
    const cartDrawer = document.getElementById('CartDrawer');

    if (cartDrawer) {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', window.location.href);
      xhr.onload = () => {
        if (xhr.status === 200) {
          const parser = new DOMParser();
          const responseDoc = parser.parseFromString(xhr.responseText, 'text/html');
          const newContent = responseDoc.querySelector('#CartDrawer');
          if (newContent) {
            cartDrawer.innerHTML = newContent.innerHTML;
            document.querySelectorAll(".cart-item .loading__spinner").forEach(el => {
              el.classList.add("hidden");
            });
            fetch('/cart.js', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
           })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then(cartData => {
              
              checkAndToggleCheckoutButtons(cartData);
            })
          }
        }
      };
      xhr.send();
    }
  }

function checkAndToggleCheckoutButtons(cart) {
    if (!cart) return;

    const approvalRequired = cart.total_price >= window.draftorder_threshold;

    const checkoutButtons = document.querySelectorAll('button[name="checkout"]');
    for (const btn of checkoutButtons) {
      if (approvalRequired) {
        document.querySelector('button[data-show-go-to-checkout-param="true"]')?.classList.add("hidden");
        btn.classList.add("hidden");
        document.querySelectorAll("#create-draft-order").forEach(el => {
          el.classList.remove("hidden");
        });
      } else {
        document.querySelector('button[data-show-go-to-checkout-param="true"]')?.classList.remove("hidden");
        document.querySelectorAll("#create-draft-order").forEach(el => {
          el.classList.add("hidden");
        });
        btn.classList.remove("hidden");
      }
    }
}


subscribe(PUB_SUB_EVENTS.cartUpdate, (event) => {
  fetch('/cart.js')
  .then(res => res.json())
  .then(cart => checkAndToggleCheckoutButtons(cart))
  .catch(err => console.error('Cart fetch failed:', err));
});


document.addEventListener('DOMContentLoaded', () => {
  
  const cartIcons = document.querySelectorAll('.header__icon--cart');

  for (const icon of cartIcons) {
    icon.addEventListener('click', () => {
      fetch('/cart.js')
        .then(res => res.json())
        .then(cart => checkAndToggleCheckoutButtons(cart))
        .catch(err => console.error('Cart fetch failed:', err));
    });
  }

  fetch('/cart.js')
  .then(res => res.json())
  .then(cart => checkAndToggleCheckoutButtons(cart))
  .catch(err => console.error('Cart fetch failed:', err));
});


}

// subscribe(PUB_SUB_EVENTS.variantChange, async function (e) {
//   if(document.querySelector(".product__info-container p .trimark-red")) {
//   document.querySelector(".product__info-container p .trimark-red").innerText = e.data.variant.sku;
//   }
// })

subscribe(PUB_SUB_EVENTS.cartUpdate, async function (e) {
  const rows = document.querySelectorAll('#quick-order-products .variant-item');
  rows.forEach(row => {
    const variantId = row.dataset.variantId;
    const cart = e.cartData;
    const cartItem = cart.items.find(i => i.variant_id.toString() === variantId);

    document.querySelector('#cart-click .cart-items_count').innerText = `CART (${cart.items.length} PRODUCTS, ${cart.item_count} QUANTITY)`;

    if (cartItem) {

      const qtyInput = row.querySelector('.quantity__input');
      if (qtyInput) qtyInput.value = cartItem.quantity;

      const totals = row.querySelectorAll('.variant-item__totals .price');
      totals.forEach(totalEl => {
        totalEl.textContent = `$${(cartItem.price * cartItem.quantity / 100).toFixed(2)}`;
      });
    } else {
      const totals = row.querySelectorAll('.variant-item__totals .price');
      totals.forEach(totalEl => {
        totalEl.textContent = "$0";
      });
    }
  });
})

document.addEventListener("pc-cart:added", function (event) {
  
  function refreshCart() {
  const cartDrawer = document.getElementById('CartDrawer');
  const cartIcon = document.getElementById('cart-icon-bubble');

  if (cartDrawer) {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', shopUrl);
    xhr.onload = () => {
      if (xhr.status === 200) {
        const parser = new DOMParser();
        const responseDoc = parser.parseFromString(xhr.responseText, 'text/html');

        if (cartDrawer) {
          const newDrawer = responseDoc.querySelector('#CartDrawer');
          const newCartIcon = responseDoc.querySelector('#cart-icon-bubble');

          if (newCartIcon) cartIcon.innerHTML = newCartIcon.innerHTML;
          if (newDrawer) cartDrawer.innerHTML = newDrawer.innerHTML;
          cartIcon.click();
        }

      }
    };
    xhr.send();
  }


}

 refreshCart();
if(document.querySelector("cart-drawer").classList.contains("is-empty")) {
    document.querySelector("cart-drawer").classList.remove("is-empty");
}
fetch('/cart.js')
  .then(res => res.json())
  .then(cart => {
    document.querySelectorAll('.cart-count-bubble span').forEach(el => {
          el.innerHTML = cart.item_count;
        });
  });
});

